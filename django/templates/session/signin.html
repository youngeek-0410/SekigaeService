<!-- TODO: refactoring -->

{% extends 'base.html' %}
{% load static %}

{% block title %}sign in{% endblock %}

{% block extrahead %}
<!-- ajax -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<!-- firebase ui -->
<script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />
{% endblock %}

{% block content %}
<!-- 以下の二つのdivはjsによってマウントされます。 -->
<div id="firebaseui-auth-container"></div>
<div id="loader">Loading...</div>


<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>

<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-analytics.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>

<script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig={
        apiKey: "AIzaSyAbxRa7smokqDD8jeBzqlcH18oPiyK53Ns",
        authDomain: "sekigaeservice.firebaseapp.com",
        projectId: "sekigaeservice",
        storageBucket: "sekigaeservice.appspot.com",
        messagingSenderId: "495374335307",
        appId: "1:495374335307:web:a552c2bdf679edc6547cce",
        measurementId: "G-SZZ1X0Y38Y"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Initialize the FirebaseUI Widget using Firebase.

    const ui=new firebaseui.auth.AuthUI(firebase.auth());
    const uiConfig={
        callbacks: {
            signInSuccessWithAuthResult: (authResult, redirectUrl) => {
                authResult.user.getIdToken(true)
                    .then((idToken) => { djangoLogin(authResult.additionalUserInfo.isNewUser, idToken) })
                    .catch((error) => { console.log(`Firebase getIdToken failed!: ${error.message}`) });
                return false; // djangosへajaxでリクエストを送る
            },
            uiShown: function () {
                // The widget is rendered.
                // Hide the loader.
                document.getElementById('loader').style.display='none';
            }
        },
        // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
        signInFlow: 'redirect',
        // signInSuccessUrl: 'temp-index',
        signInOptions: [
            // Leave the lines as is for the providers you want to offer your users.
            firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        ],
        // Terms of service url.
        tosUrl: 'terms-of-service',
        // Privacy policy url.
        privacyPolicyUrl: 'privacy-policy'
    };

    // The start method will wait until the DOM is loaded.
    ui.start('#firebaseui-auth-container', uiConfig);
    // using jQuery
    function getCookie(name) {
        var cookieValue=null;
        if (document.cookie&&document.cookie!='') {
            var cookies=document.cookie.split(';');
            for (var i=0;i<cookies.length;i++) {
                var cookie=jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length+1)==(name+'=')) {
                    cookieValue=decodeURIComponent(cookie.substring(name.length+1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken=getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    const authorizationObj=(idToken) => {
        return { "Authorization": `Bearer ${idToken}` };
    }

    const djangoLogin=(isNewUser, idToken) => {
        const url="/signin-callback";
        const headers=Object.assign(authorizationObj(idToken));

        $.ajax({
            url: url,
            type: 'POST',
            headers: headers
        }).done((response) => {
            window.location.href=response;
        })
    }


</script>
{% endblock %}