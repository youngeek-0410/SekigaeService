<!-- TODO: refactoring -->

{% extends 'base.html' %}
{% load static %}

{% block title %}temp top page{% endblock %}

{% block extrahead %}
<!-- ajax -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
{% endblock %}

{% block content %}
<h1>Welcome to sekigae...</h1>

<div id="isLogined">
    <h3>userinfo</h3>
    <p>{{user.username}}</p>
    <p>{{user.email}}</p>
    <input type="button" value="signout" onclick="signOut()" />
</div>

<div id="isntLogined">
    <a href="{% url 'session:signin' %}">sign in is here</a>
</div>

<p>actually</p>
<p>{{user.username}}</p>
<p>{{user.email}}</p>


<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>

<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-analytics.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>

<script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig={
        apiKey: "AIzaSyAbxRa7smokqDD8jeBzqlcH18oPiyK53Ns",
        authDomain: "sekigaeservice.firebaseapp.com",
        projectId: "sekigaeservice",
        storageBucket: "sekigaeservice.appspot.com",
        messagingSenderId: "495374335307",
        appId: "1:495374335307:web:a552c2bdf679edc6547cce",
        measurementId: "G-SZZ1X0Y38Y"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    //ログイン状況に応じて表示するdivを変更
    const isLogined=document.getElementById("isLogined");
    const isntLogined=document.getElementById("isntLogined");
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            isLogined.style.display="block";
            isntLogined.style.display="none";
        } else {
            isLogined.style.display="none";
            isntLogined.style.display="block";
        }
    });

    function getCookie(name) {
        var cookieValue=null;
        if (document.cookie&&document.cookie!='') {
            var cookies=document.cookie.split(';');
            for (var i=0;i<cookies.length;i++) {
                var cookie=jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length+1)==(name+'=')) {
                    cookieValue=decodeURIComponent(cookie.substring(name.length+1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken=getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function djangoSignout() {
        $.ajax({
            url: "signout",
            type: 'POST',
        }).done((response) => {
            window.location.href=response;
        })
    }

    function signOut() {
        firebase.auth().onAuthStateChanged(user => {
            firebase
                .auth()
                .signOut()
                .then(() => {
                    djangoSignout();
                    location.reload();
                })
                .catch((error) => {
                    console.log(`ログアウト時にエラーが発生しました (${error})`);
                });
        });
    }

</script>
{% endblock %}